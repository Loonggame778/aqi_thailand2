<h1>Table of Contents<span class="tocSkip"></span></h1>
<div class="toc"><ul class="toc-item"><li><span><a href="#Model-Air-Pollution-Thailand-and-South-East-Asian-Countries" data-toc-modified-id="Model-Air-Pollution-Thailand-and-South-East-Asian-Countries-1"><span class="toc-item-num">1&nbsp;&nbsp;</span>Model Air Pollution Thailand and South East Asian Countries</a></span></li><li><span><a href="#Requirements" data-toc-modified-id="Requirements-2"><span class="toc-item-num">2&nbsp;&nbsp;</span>Requirements</a></span></li><li><span><a href="#Directory-Tree" data-toc-modified-id="Directory-Tree-3"><span class="toc-item-num">3&nbsp;&nbsp;</span>Directory Tree</a></span></li><li><span><a href="#Data-Sources" data-toc-modified-id="Data-Sources-4"><span class="toc-item-num">4&nbsp;&nbsp;</span>Data Sources</a></span><ul class="toc-item"><li><span><a href="#Pollution-Data" data-toc-modified-id="Pollution-Data-4.1"><span class="toc-item-num">4.1&nbsp;&nbsp;</span>Pollution Data</a></span></li><li><span><a href="#Weather-Data" data-toc-modified-id="Weather-Data-4.2"><span class="toc-item-num">4.2&nbsp;&nbsp;</span>Weather Data</a></span></li><li><span><a href="#Hotspot-Data" data-toc-modified-id="Hotspot-Data-4.3"><span class="toc-item-num">4.3&nbsp;&nbsp;</span>Hotspot Data</a></span></li></ul></li><li><span><a href="#AQI-Convention" data-toc-modified-id="AQI-Convention-5"><span class="toc-item-num">5&nbsp;&nbsp;</span>AQI Convention</a></span></li><li><span><a href="#Modeling-Air-Pollution-in-Chiang-Mai-Data-:-A-Case-Study" data-toc-modified-id="Modeling-Air-Pollution-in-Chiang-Mai-Data-:-A-Case-Study-6"><span class="toc-item-num">6&nbsp;&nbsp;</span>Modeling Air Pollution in Chiang Mai Data : A Case Study</a></span><ul class="toc-item"><li><span><a href="#Casual-Diagram" data-toc-modified-id="Casual-Diagram-6.1"><span class="toc-item-num">6.1&nbsp;&nbsp;</span>Casual Diagram</a></span></li><li><span><a href="#A-Dataset-Object" data-toc-modified-id="A-Dataset-Object-6.2"><span class="toc-item-num">6.2&nbsp;&nbsp;</span>A Dataset Object</a></span></li><li><span><a href="#Exploratory-Data-Analysis" data-toc-modified-id="Exploratory-Data-Analysis-6.3"><span class="toc-item-num">6.3&nbsp;&nbsp;</span>Exploratory Data Analysis</a></span><ul class="toc-item"><li><span><a href="#Geography" data-toc-modified-id="Geography-6.3.1"><span class="toc-item-num">6.3.1&nbsp;&nbsp;</span>Geography</a></span></li></ul></li></ul></li><li><span><a href="#Machine-Learning-Model" data-toc-modified-id="Machine-Learning-Model-7"><span class="toc-item-num">7&nbsp;&nbsp;</span>Machine Learning Model</a></span><ul class="toc-item"><li><span><a href="#Training" data-toc-modified-id="Training-7.1"><span class="toc-item-num">7.1&nbsp;&nbsp;</span>Training</a></span></li><li><span><a href="#Model-Performance" data-toc-modified-id="Model-Performance-7.2"><span class="toc-item-num">7.2&nbsp;&nbsp;</span>Model Performance</a></span></li></ul></li></ul></div>

# Model Air Pollution Thailand and South East Asian Countries

This project aims to use a machine learning model predict and identify sources of the air pollution South East Asian cities. Because this is a multi-variables problem with complex interaction among features, and time-lag, a machine learning approch has an advantage over a traditional approach. Here, random forest regressor(RF) is used to model a small particle pollution(PM2.5) level. After trying searching various machine learning model, I found that RF perform the best. In addition, the model can be easily interpreted. The model's feature of importances in combination data exploration helps identify the major sources of air pollution. In addition, I will use the model to simulate the pollution level when an environmental policies are implemented. I use Chiang Mai as a case study, but the codes works with other cities such as Bangkok, and Hanoi (Given there are enough data, of course!)

# Requirements

numpy==1.18.1<br>
matplotlib==3.1.2<br>
pandas==1.0.0<br>
geopandas==0.6.2<br>
scikit_optimize==0.7.4 <br>
scikit_learn==0.23.2<br>
TPOT==0.11.5<br>
statsmodels==0.11.1<br>
scipy==1.4.1<br>
seaborn==0.10.0<br>
joblib==0.14.1<br>
tqdm==4.43.0<br>
Shapely==1.7.0<br>
pyproj==2.4.2.post1<br>
Fiona==1.8.13<br>
bokeh==2.1.1<br>
selenium==3.141.0 <br>
wget==3.2<br>
beautifulsoup4==4.9.1<br>
requests==2.22.0<br>
swifter==1.0.3<br>
Sphinx>=1.6.0<br>

# Directory Tree

<pre>
├── README.md   
├── requirements.txt : generated by pipreqs
├── data : raw data and processed data for each cities. Please see the data section for details about how to obtains the raw data
├── docs._build.html : code documentations generated by Sphinx 
├── models : each subfolder contains a model for a each city.  
│   ├──  chiang_mai : contains random forest models for Chiang Mai and model meta file containing setting
│   └── bangkok   
├── reports : plots for each city 
│   ├── chiang_mai : data and model visualizations for Chiang Mai
│   └── bangkok   
├── notebooks   
│   ├── 1_pollutions_data.ipynb : 
│   ├── 1.1_vn_power_plants.ipynb : 
│   ├── 2_analyze_pollution_data.ipynb : 
│   ├── 5.0-ML_Chiang_mai.ipynb : 
│   ├── 6.0_vis_ChiangMai.ipynb : 
│   ├── 6.1_BKK.ipynb : 
│   ├── 6.2_vis_Jarkata.ipynb : 
│   ├── 6.3_Hanoi.ipynb : 
│   └── 7_prediction.ipynb : 
│   
└── src : the source codes are meant to be ran as a module not as .py (except for vn_data.py) 
    ├── imports.py : 
    ├── gen_functions.py : general purpose functions such as color setting, AQI conversion and coordinate Conversion
    ├── data : download and preprocess data 
    │   ├── download_data.py :  download pollution data from various sources 
    │   ├── read_data.py :  read pollution data 
    │   ├── vn_data.py : scrape pollution data from Vietnamese EPA
    │   ├── weather_data.py : scrape, process and load weather data
    │   └── fire_data.py : process and load hotspots data
    │     
    ├── features   
    │   ├── build_features.py : 
    │   └── dataset.py : Dataset object is responsible for putting raw data together, 
    │                    feature engineering and preparing matricies for machine learning models. 
    │                    Call read_data.py when loading data
    │                    Call build_features.py for feature engineering functions 
    ├── models   
    │   ├── train_model.py :  model builder and hyperparameter searcher
    │   └── predict_model.py : load model and perform statistical simulations
    │   
    └── visualization  
        ├── vis_data.py : create plots for data exploration steps   
        └── vis_model.py : create plots for visualizing model performance and simulation 
</pre>

# Data Sources

## Pollution Data
 - [Thailand Pollution Department](http://air4thai.pcd.go.th/webV2/) Data only go back 2 months! so need to run scapper once a month using `src.data.download_data.update_last_air4Thai()` . Once can also writes a letter to ask for historical data directly. The request took about a month to process. The data has to be parsed from their excel files.  
 - [Vietnamese Pollution Department](http://enviinfo.cem.gov.vn/) Pollution data for major cities such as Hanoi. Data only go back 24 hours, so need to run scapper once a day. This is done using using `src.data.vn_data.download_vn_data()`
 - [Berkeley project](http://berkeleyearth.org/) provides historical PM2.5 data back until late 2016 
 - [US Embassy](http://dosairnowdata.org/dos/historical/) US embassy in some cities collect PM2.5 data. Use `src.data.download_data.download_us_emb_data()` to download data. 
 - [Chiang Mai University Monitoring Stations](https://www.cmuccdc.org/) provides data from the University monitoring stations in the northern part of Thailand. Use `src.data.download_data..download_cdc_data()` to download this data.  
 - [The World Air
Quality Project](https://aqicn.org/) has pollutions data from many cities, but only provide daily average data  

## Weather Data 

Weather data is from two sources. 

- [OpenWeathermap](https://openweathermap.org/history) provides a bulk historial data to purchase. The data is processed using `src.data.weather_data.proc_open_weather()`
- Additional weather data is constantly scraped from [Weather Underground)(https://www.wunderground.com/) `src.data.weather_data.update_weather()` 

Both the pollution data and weather data are can be downloaded using one single command `src.data.download_data.main()`


## Hotspot Data 

Satellite data showing location of burning activities(hotspots) from NASA https://firms.modaps.eosdis.nasa.gov/download/. There are three data product. This study uses MODIS Collection 6 data because of the data available for a longer period that other products.

# AQI Convention

Countries have different standards, which convert the raw polution readings into air quality index(AQI) and interpret the harmful levels. The maximum AQIs for each pollutants (PM2.5, Pm10, SO2 etc) is reported at a single AQI. The figure belows compare US and Thailand AQI. The standards are comparable except for SO$_2$, where the US has a stricker standard. This study use US AQI conversion standard for calculating AQI for different pollutants. For example, in the PM2.5 case 
- 0 - 50 AQI is in a healthy range. This corresponds to PM2.5 level between 0 - 12 $\mu g/m^3$ (green). 
- 50 - 100 AQI is a moderate range, corresponding to PM2.5 12- 35.4  $\mu g/m^3$ (orange)
- 100 - 150 AQI is a unhealthy for sensitive group, corresponding to PM2.5 35.5- 55.4  $\mu g/m^3$ (red)
- 150 - 200 AQI is a unhealthy range, corresponding to PM2.5 55.5- 150.4  $\mu g/m^3$ (red)

For simplicity, the color code in this study groups the  100 - 150 and 150 - 200 as unhealthy range(red). 


```python
#  Load the "autoreload" extension so that code can change
%reload_ext autoreload
%autoreload 2
import src
```


```python
src.visualization.vis_data.compare_aqis(filename='../reports/chiang_mai/aqi.png')
```

![png](https://github.com/worasom/aqi_thailand2/blob/master/reports/chiang_mai/aqi.png)

#  Modeling Air Pollution in Chiang Mai Data : A Case Study

## Casual Diagram

There are four possible sources of air pollution: local traffic, power plants, industrial activities, and agricultural burning. For the latter three sources, the pollution is generated from the other provinces. In all of these sources, the local weather (temperature, humidity, and wind speed) decides how long the pollution stays in the air, and thus the pollution level. 

Since each pollution source results in different seasonal pollution patterns and chemical characteristics(chemical finger print), inspecting the pollutions data, weather, and several burning hotspots seen from the satellite images and the patterns could help identify or rule out air pollution contribution factors. This is done in [exploratory data analysis section](#Exploratory-Data-Analysis-6.2).


<img src="https://github.com/worasom/aqi_thailand2/blob/master/reports/chiang_mai/casual_di.PNG" width="500"/>

## A Dataset Object

It is more convenience to have a `Dataset` object that keep tracks of all relavant data for a city along with necessary meta information such as city location etc. This is object is under `src.features.dataset.py`.

The `Dataset` object is also in charge of compile raw pollution, weather, fire data from the data folder into a ready-to-use format. The processed data are saved under ../data/city_name/. The code below illustrates how to `Dataset` object compile the data using a build_all_data command.


```python
# init a dataset object and build the data from scratch 
# only perform this when new data files are added 
dataset = src.features.dataset.Dataset('Chiang Mai')

# build pollution,  weather data and (optional) fire data
dataset.build_all_data( build_fire=True, build_holiday=True)
```

After the building process, which might take sometimes because of the size of the fire data (building the fire data is optional and can be set to false (`build_fire=False`). The complied data can be loaded using `_load()` command.


```python
# reinit the data and load saved process data 
dataset = src.features.dataset.Dataset('Chiang Mai')
dataset.load_()
```

The pollution data is under `poll_df` attribute


```python
dataset.poll_df.tail(2)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PM2.5</th>
      <th>PM10</th>
      <th>O3</th>
      <th>CO</th>
      <th>NO2</th>
      <th>SO2</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-17 15:00:00</th>
      <td>8.5</td>
      <td>19.5</td>
      <td>15.0</td>
      <td>0.40</td>
      <td>5.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2020-06-17 16:00:00</th>
      <td>7.5</td>
      <td>16.5</td>
      <td>11.0</td>
      <td>0.43</td>
      <td>5.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div>



The weather data is under `wea` attribute


```python
dataset.wea.tail(2)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Temperature(C)</th>
      <th>Humidity(%)</th>
      <th>Wind</th>
      <th>Wind Speed(kmph)</th>
      <th>Condition</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-17 23:00:00</th>
      <td>25.0</td>
      <td>94.0</td>
      <td>VAR</td>
      <td>3.0</td>
      <td>Partly Cloudy</td>
    </tr>
    <tr>
      <th>2020-06-17 23:30:00</th>
      <td>25.0</td>
      <td>94.0</td>
      <td>VAR</td>
      <td>3.0</td>
      <td>Partly Cloudy</td>
    </tr>
  </tbody>
</table>
</div>



The weather data is under `fire` attribute


```python
dataset.fire.tail(2)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>latitude</th>
      <th>longitude</th>
      <th>confidence</th>
      <th>lat_km</th>
      <th>long_km</th>
      <th>distance</th>
      <th>power</th>
      <th>count</th>
      <th>country</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2020-06-12 22:25:00</th>
      <td>26.620</td>
      <td>101.59</td>
      <td>81</td>
      <td>3057</td>
      <td>11309</td>
      <td>983.717439</td>
      <td>6.1</td>
      <td>1</td>
      <td>China</td>
    </tr>
    <tr>
      <th>2020-06-12 22:25:00</th>
      <td>26.621</td>
      <td>101.60</td>
      <td>83</td>
      <td>3057</td>
      <td>11310</td>
      <td>984.012703</td>
      <td>6.8</td>
      <td>1</td>
      <td>China</td>
    </tr>
  </tbody>
</table>
</div>



Additionally the dataset also has city information under `city_info` attribute


```python
dataset.city_info
```




    {'Country': 'Thailand',
     'City': 'Chiang Mai',
     'City (ASCII)': 'Chiang Mai',
     'Region': 'Chiang Mai',
     'Region (ASCII)': 'Chiang Mai',
     'Population': '200952',
     'Latitude': '18.7904',
     'Longitude': '98.9847',
     'Time Zone': 'Asia/Bangkok',
     'lat_km': 2117.0,
     'long_km': 11019.0}



## Exploratory Data Analysis

The first step before any machine learning model is to understand the data. The file `src.visualization.vis_data.py` contains many useful functions for quick data visualization. Here, pollution data in Chiang Mai is used to illustrate visualization functions. 

### Geography

It is important to understand the geography of the city. The picture belows show a map of Chiang Mai. It is a medium size surrounded by high mountains. Locations of the monitoring stations, near by industrial complex and power plants are also shown.

I have two handy functions to convert logtitude, latitude coordinates to Mercator projection and vice versa. They are `src.gen_functions.merc_x`, `src.gen_functions.merc_y`, and `src.gen_functions.to_latlon`

![map of Chiang Mai](https://github.com/worasom/aqi_thailand2/blob/master/reports/chiang_mai/cm_map.png)

![different pollutants](https://github.com/worasom/aqi_thailand2/blob/master/reports/chiang_mai/all_pol_aqi.png)

Seasonal patterns of PM2.5 level(top), number of hotspots within 1000 km from Chiang Mai(middle), and temperature(bottom). The shaded regions are 95% confident interval from different years. (top) the horizontal lines indicate the values corresponded to AQI 100 (moderate) and 150 (unhealthy) accordingly. The number of hotspots has a similar seasonal pattern as the PM2.5’s.

![seasonal pattern](https://github.com/worasom/aqi_thailand2/blob/master/reports/chiang_mai/fire_PM25_t_season.png)

![seasonal pattern](https://github.com/worasom/aqi_thailand2/blob/master/reports/chiang_mai/fire_PM25_season.png)

# Machine Learning Model

## Training

Model Optimization breakdown into the following steps

1. Build dataset using default fire parameter. Split the data into train, validation and test set. Optimize for a reasonable RandomForestRegressor model  
2. Remove lower importance features from the model  
3. Optimize for the best fire features
4. Improve model performance by adding lag columns (of weather and fire)
5. Remove lower importance lag columns 
6. Optimize for better model parameters again  
7. Save model and model meta information 

These steps are carried out in a single line of code. The entire optimization tooks about 3 hours to complete in my computer.


```python
dataset, rf_model, model_meta = src.models.train_model.train_city_s1(city='Chiang Mai', pollutant='PM2.5')
```

## Model Performance


```python

```
